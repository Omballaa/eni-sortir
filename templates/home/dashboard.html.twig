{% extends 'base.html.twig' %}

{% block title %}Accueil - {{ parent() }}{% endblock %}

{% block body %}
    {# En-tête avec informations utilisateur #}
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="h3 mb-0">
                <i class="bi bi-house-door"></i> Accueil
            </h1>
        </div>
        <div class="col-md-4 text-end">
            <div class="text-muted">
                <small>Date du jour : {{ "now"|date("d/m/Y") }}</small><br>
                <small>Participant : {{ user.prenom }} {{ user.nom }}</small>
            </div>
        </div>
    </div>

    {# Section des filtres #}
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="card-title mb-0">
                <i class="bi bi-funnel"></i> Filtrer les sorties
            </h5>
        </div>
        <div class="card-body">
            <form method="get" action="{{ path('app_home') }}">
                <div class="row g-3">
                    {# Site #}
                    <div class="col-md-3">
                        <label for="site" class="form-label">Site :</label>
                        <select name="site" id="site" class="form-select">
                            <option value="">Tous les sites</option>
                            {% for siteOption in sites %}
                                <option value="{{ siteOption.id }}" 
                                        {% if filtres.site == siteOption.id %}selected{% endif %}>
                                    {{ siteOption.nomSite }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    {# Nom de la sortie #}
                    <div class="col-md-3">
                        <label for="nom" class="form-label">Le nom de la sortie contient :</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text" name="nom" id="nom" class="form-control" 
                                   value="{{ filtres.nom }}" placeholder="Rechercher...">
                        </div>
                    </div>

                    {# Dates avec labels intégrés #}
                    <div class="col-md-4">
                        <label class="form-label">Période :</label>
                        <div class="row g-2">
                            <div class="col-6">
                                <div class="input-group">
                                    <span class="input-group-text">Du</span>
                                    <input type="date" name="dateDebut" id="dateDebut" class="form-control" 
                                           value="{{ filtres.dateDebut }}">
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="input-group">
                                    <span class="input-group-text">Au</span>
                                    <input type="date" name="dateFin" id="dateFin" class="form-control" 
                                           value="{{ filtres.dateFin }}">
                                </div>
                            </div>
                        </div>
                    </div>

                    {# Bouton rechercher aligné #}
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <button type="button" onclick="refreshSortiesList()" class="btn btn-primary w-100 d-block">
                            <i class="bi bi-search"></i> Rechercher
                        </button>
                    </div>
                </div>

                {# Options de filtrage #}
                <div class="row mt-3">
                    <div class="col-md-12">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" name="organisateurSeulement" 
                                   id="organisateurSeulement" value="1" 
                                   {% if filtres.organisateurSeulement %}checked{% endif %}>
                            <label class="form-check-label" for="organisateurSeulement">
                                Sorties dont je suis l'organisateur/trice
                            </label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="inscriptionFilter" id="toutesSorties" value="toutes" {% if filtres.inscriptionFilter == 'toutes' or not filtres.inscriptionFilter %}checked{% endif %}>
                            <label class="form-check-label" for="toutesSorties">
                                Toutes les sorties
                            </label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="inscriptionFilter" id="inscritSeulement" value="inscritSeulement" {% if filtres.inscriptionFilter == 'inscritSeulement' %}checked{% endif %}>
                            <label class="form-check-label" for="inscritSeulement">
                                Sorties auxquelles je suis inscrit/e
                            </label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="inscriptionFilter" id="nonInscritSeulement" value="nonInscritSeulement" {% if filtres.inscriptionFilter == 'nonInscritSeulement' %}checked{% endif %}>
                            <label class="form-check-label" for="nonInscritSeulement">
                                Sorties auxquelles je ne suis pas inscrit/e
                            </label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" name="sortiesPassees" 
                                   id="sortiesPassees" value="1" 
                                   {% if filtres.sortiesPassees %}checked{% endif %}>
                            <label class="form-check-label" for="sortiesPassees">
                                Sorties passées
                            </label>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    {# Tableau des sorties #}
    <div class="card" id="sorties-list">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="bi bi-calendar-event"></i> Liste des sorties 
                <span class="badge bg-primary">{{ sorties|length }}</span>
            </h5>
            <button type="button" onclick="openSortieCreateModal()" class="btn btn-success btn-sm">
                <i class="bi bi-plus-circle"></i> Créer une sortie
            </button>
        </div>
        <div class="card-body p-0" id="sorties-container">
            {% if sorties|length > 0 %}
                {{ include('home/_sorties_list.html.twig', {'sorties': sorties, 'user': user}) }}
            {% else %}
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                    <p class="text-muted mt-3">Chargement des sorties...</p>
                </div>
            {% endif %}
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Chargement automatique des sorties au démarrage
            setTimeout(() => {
                refreshSortiesList();
            }, 100);
            
            // Auto-refresh optionnel sur changement de certains filtres
            const siteSelect = document.getElementById('site');
            if (siteSelect) {
                siteSelect.addEventListener('change', function() {
                    // Attendre un petit délai pour éviter trop de requêtes
                    setTimeout(() => {
                        refreshSortiesList();
                    }, 300);
                });
            }

            // Recherche en temps réel sur le nom (avec debounce)
            const nomInput = document.getElementById('nom');
            let searchTimeout;
            if (nomInput) {
                nomInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        refreshSortiesList();
                    }, 800); // Attendre 800ms après la dernière frappe
                });
            }

            // Auto-refresh sur changement des dates (avec debounce)
            let dateTimeout;
            const dateDebut = document.getElementById('dateDebut');
            const dateFin = document.getElementById('dateFin');
            
            if (dateDebut) {
                dateDebut.addEventListener('change', function() {
                    clearTimeout(dateTimeout);
                    dateTimeout = setTimeout(() => {
                        refreshSortiesList();
                    }, 500);
                });
            }
            
            if (dateFin) {
                dateFin.addEventListener('change', function() {
                    clearTimeout(dateTimeout);
                    dateTimeout = setTimeout(() => {
                        refreshSortiesList();
                    }, 500);
                });
            }

            // Auto-refresh sur changement des checkboxes
            const checkboxes = [
                'organisateurSeulement',
                'sortiesPassees'
            ];

            checkboxes.forEach(checkboxId => {
                const checkbox = document.getElementById(checkboxId);
                if (checkbox) {
                    checkbox.addEventListener('change', function() {
                        // Refresh immédiat pour les checkboxes
                        refreshSortiesList();
                    });
                }
            });

            // Auto-refresh sur changement des radiogroups
            const radiobuttons = [
                'toutesSorties',
                'inscritSeulement',
                'nonInscritSeulement'

            ];

            radiobuttons.forEach(radiobuttonId => {
                const radiobutton = document.getElementById(radiobuttonId);
                if (radiobutton) {
                    radiobutton.addEventListener('change', function() {
                        refreshSortiesList();
                    });
                }
            });

            // Support de la touche Entrée sur tous les champs
            document.querySelectorAll('#site, #nom, #dateDebut, #dateFin').forEach(field => {
                field.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        refreshSortiesList();
                    }
                });
            });
        });
    </script>
{% endblock %}